import { getTimestamp } from "./analytics.js";
import {
  formatNumber,
  formatFloat,
  sanitizeText,
  toISODate,
  formatDisplayDate,
  formatTimestampDisplay,
} from "./utils.js";
import {
  SECTION_NAV_ITEMS,
  SEARCH_RESULT_LIMIT,
  ONBOARDING_STEPS,
} from "./appConstants.js";
import {
  setStatusCallback,
  updateStatus,
  getDatasetEntries,
  setDatasetEntries,
  setDatasetAnalytics,
  getDatasetAnalytics,
  setDatasetLabel,
  getDatasetLabel,
  setCurrentRange,
  getCurrentRange,
  setCustomRange,
  getCustomRange,
  saveChatDataset,
  listChatDatasets,
  getChatDatasetById,
  setActiveChatId,
  getActiveChatId,
  addSavedView,
  getSavedViews,
  updateSavedView,
  removeSavedView,
  clearSavedViews,
  setCompareSelection,
  getCompareSelection,
  getSearchState,
  getHourlyState,
  updateHourlyState,
  resetHourlyFilters,
  getWeekdayState,
  updateWeekdayState,
  getCachedAnalytics,
  setCachedAnalytics,
  clearAnalyticsCache,
  setDatasetFingerprint,
  getDatasetFingerprint,
  setDatasetParticipantDirectory,
  resetWeekdayFilters,
  computeDatasetFingerprint,
} from "./state.js";
import {
  formatHourLabel,
  computeTimeOfDayDataset,
} from "./analytics/activity.js";
import {
  API_BASE,
  BRAND_NAME,
  RELAY_SERVICE_NAME,
  STATUS_AUTO_HIDE_DELAY_MS,
  STATUS_EXIT_DURATION_MS,
  motionPreferenceQuery,
  initialReduceMotionPreferred,
} from "./config.js";
import { createDatasetEmptyStateManager } from "./ui.js";
import {
  createAppDomRefs,
  fetchJson,
  COMPACT_STORAGE_KEY,
  REDUCE_MOTION_STORAGE_KEY,
  HIGH_CONTRAST_STORAGE_KEY,
} from "./appShell/index.js";
import { bootstrapAppShellRuntime } from "./appShell/runtimeBootstrap.js";
import { createAppControllerWiring } from "./appShell/controllerWiring.js";
import { createAppCompositionAssembly } from "./appShell/compositionAssembly.js";
import { createAppDomRefGroups } from "./appShell/domRefGroups.js";
import {
  createRuntimeEventBindings,
  createRuntimeBootstrapDeps,
} from "./appShell/runtimeConfig.js";
import {
  buildControllerWiringArgs,
  buildCompositionAssemblyArgs,
} from "./appShell/entryConfig.js";

const appDomRefs = createAppDomRefs();
const {
  runtimeRefs,
  relayRefs,
  filterRefs,
  dashboardRefs,
  exportRefs,
  savedViewRefs,
  searchRefs,
} = createAppDomRefGroups(appDomRefs);

const {
  statusEl,
  toastContainer,
  compactToggleButton,
  reduceMotionToggle,
  highContrastToggle,
  onboardingOverlay,
  onboardingCopyEl,
  onboardingStepLabel,
  onboardingSkipButton,
  onboardingNextButton,
  sectionNavInner,
} = runtimeRefs;

const datasetEmptyStateManager = createDatasetEmptyStateManager({
  calloutEl: runtimeRefs.datasetEmptyCallout,
  headingEl: runtimeRefs.datasetEmptyHeading,
  copyEl: runtimeRefs.datasetEmptyCopy,
  buttons: [
    exportRefs.downloadPdfButton,
    exportRefs.downloadMarkdownButton,
    exportRefs.downloadSlidesButton,
    exportRefs.downloadChatJsonButton,
    exportRefs.downloadParticipantsButton,
    exportRefs.downloadHourlyButton,
    exportRefs.downloadDailyButton,
    exportRefs.downloadWeeklyButton,
    exportRefs.downloadWeekdayButton,
    exportRefs.downloadTimeOfDayButton,
    exportRefs.downloadMessageTypesButton,
    exportRefs.downloadSentimentButton,
    exportRefs.downloadSearchButton,
  ],
});
const setDatasetEmptyMessage = datasetEmptyStateManager.setMessage;
const controllerWiringState = {
  listChatDatasets,
  getActiveChatId,
  setActiveChatId,
  getDatasetEntries,
  getDatasetLabel,
  setCurrentRange,
  setCustomRange,
  getCustomRange,
  getCachedAnalytics,
  setCachedAnalytics,
  setDatasetAnalytics,
  updateStatus,
  getDatasetAnalytics,
  getCurrentRange,
  addSavedView,
  getSavedViews,
  updateSavedView,
  removeSavedView,
  clearSavedViews,
  getCompareSelection,
  setCompareSelection,
  getHourlyState,
  updateHourlyState,
  getWeekdayState,
  updateWeekdayState,
};
const controllerWiringUtils = {
  formatNumber,
  formatFloat,
  sanitizeText,
  formatDisplayDate,
  getTimestamp,
  toISODate,
};
const {
  encodeChatSelectorValue,
  setRemoteChatList,
  getRemoteChatList,
  getRemoteChatsLastFetchedAt,
  refreshChatSelector,
  handleChatSelectionChangeCore,
  analyticsRequestTracker,
  computeAnalyticsWithWorker,
  normalizeRangeValue,
  filterEntriesByRange,
  describeRange,
  updateCustomRangeBounds,
  handleRangeChange,
  applyCustomRange,
  searchController,
  savedViewsController,
  setDashboardLoadingState,
  setDataAvailabilityState,
  updateHeroRelayStatus,
  getDataAvailable,
  handleParticipantsTopChange,
  handleParticipantsSortChange,
  handleParticipantsTimeframeChange,
  handleParticipantPresetClick,
  handleParticipantRowToggle,
  getExportFilterSummary,
  getParticipantView,
  renderDashboard,
  ensureWeekdayDayFilters,
  ensureWeekdayHourFilters,
  rerenderHourlyFromState,
  rerenderWeekdayFromState,
  ensureDayFilters,
  syncHourlyControlsWithState,
  initThemeControls,
  getExportThemeConfig,
} = createAppControllerWiring(
  buildControllerWiringArgs({
    filterRefs,
    dashboardRefs,
    savedViewRefs,
    searchRefs,
    runtimeRefs,
    state: controllerWiringState,
    utils: controllerWiringUtils,
    brandName: BRAND_NAME,
    searchResultLimit: SEARCH_RESULT_LIMIT,
    datasetEmptyStateManager,
    setDatasetEmptyMessage,
  }),
);
const compositionAssemblyState = {
  getDatasetFingerprint,
  getDatasetAnalytics,
  getDatasetEntries,
  getDatasetLabel,
  getCurrentRange,
  getSearchState,
  updateStatus,
  setDatasetEntries,
  setDatasetFingerprint,
  setDatasetParticipantDirectory,
  clearAnalyticsCache,
  setDatasetLabel,
  setCurrentRange,
  setCustomRange,
  resetHourlyFilters,
  resetWeekdayFilters,
  computeDatasetFingerprint,
  saveChatDataset,
  setCachedAnalytics,
  setDatasetAnalytics,
  setActiveChatId,
  getChatDatasetById,
  setDatasetEmptyMessage,
  fetchJson,
};
const compositionAssemblyUtils = {
  formatNumber,
  formatFloat,
  formatTimestampDisplay,
};
const compositionAssemblyWiring = {
  getExportFilterSummary,
  getExportThemeConfig,
  getParticipantView,
  describeRange,
  filterEntriesByRange,
  normalizeRangeValue,
  analyticsRequestTracker,
  computeAnalyticsWithWorker,
  renderDashboard,
  updateCustomRangeBounds,
  encodeChatSelectorValue,
  setRemoteChatList,
  getRemoteChatList,
  getRemoteChatsLastFetchedAt,
  refreshChatSelector,
  savedViewsController,
  searchController,
  setDashboardLoadingState,
  setDataAvailabilityState,
  updateHeroRelayStatus,
  handleChatSelectionChangeCore,
};
const {
  exportParticipants,
  exportHourly,
  exportDaily,
  exportWeekly,
  exportWeekday,
  exportTimeOfDay,
  exportMessageTypes,
  exportChatJson,
  exportSentiment,
  exportSearchResults,
  handleDownloadMarkdownReport,
  handleDownloadSlidesReport,
  exportMessageSubtype,
  handleDownloadPdfReport,
  startRelaySession,
  stopRelaySession,
  syncRelayChats,
  isLogDrawerOpen,
  openLogDrawer,
  closeLogDrawer,
  initRelayControls,
  handleChatSelectionChange,
} = createAppCompositionAssembly(
  buildCompositionAssemblyArgs({
    filterRefs,
    runtimeRefs,
    relayRefs,
    state: compositionAssemblyState,
    utils: compositionAssemblyUtils,
    analytics: {
      computeTimeOfDayDataset,
      formatHourLabel,
    },
    brandName: BRAND_NAME,
    apiBase: API_BASE,
    wiring: compositionAssemblyWiring,
    electronAPI: window.electronAPI,
  }),
);

const runtimeEventBindings = createRuntimeEventBindings({
  filterRefs,
  exportRefs,
  dashboardRefs,
  handlers: {
    handleChatSelectionChange,
    handleRangeChange,
    exportParticipants,
    exportHourly,
    exportDaily,
    exportWeekly,
    exportWeekday,
    exportTimeOfDay,
    exportMessageTypes,
    exportChatJson,
    exportSentiment,
    exportMessageSubtype,
    handleDownloadMarkdownReport,
    handleDownloadSlidesReport,
    exportSearchResults,
    handleDownloadPdfReport,
    handleParticipantsTopChange,
    handleParticipantsSortChange,
    handleParticipantsTimeframeChange,
    handleParticipantPresetClick,
    handleParticipantRowToggle,
  },
  deps: {
    updateStatus,
    applyCustomRange,
    updateWeekdayState,
    ensureWeekdayDayFilters,
    rerenderWeekdayFromState,
    ensureWeekdayHourFilters,
    updateHourlyState,
    getHourlyState,
    ensureDayFilters,
    syncHourlyControlsWithState,
    rerenderHourlyFromState,
  },
});

const runtimeBootstrapDeps = createRuntimeBootstrapDeps({
  deps: {
    initRelayControls,
    initThemeControls,
    setDataAvailabilityState,
    startRelaySession,
    stopRelaySession,
    searchController,
    savedViewsController,
    getDataAvailable,
    refreshChatSelector,
    updateStatus,
  },
  relayServiceName: RELAY_SERVICE_NAME,
});

bootstrapAppShellRuntime({
  statusConfig: {
    setStatusCallback,
    statusEl,
    toastContainer,
    autoHideDelayMs: STATUS_AUTO_HIDE_DELAY_MS,
    exitDurationMs: STATUS_EXIT_DURATION_MS,
  },
  sectionNavConfig: {
    containerEl: sectionNavInner,
    navItemsConfig: SECTION_NAV_ITEMS,
  },
  compactConfig: {
    toggle: compactToggleButton,
    storageKey: COMPACT_STORAGE_KEY,
  },
  accessibilityConfig: {
    reduceMotionToggle,
    highContrastToggle,
    motionPreferenceQuery,
    initialReduceMotionPreferred,
    reduceMotionStorageKey: REDUCE_MOTION_STORAGE_KEY,
    highContrastStorageKey: HIGH_CONTRAST_STORAGE_KEY,
  },
  onboardingConfig: {
    overlayEl: onboardingOverlay,
    copyEl: onboardingCopyEl,
    stepLabelEl: onboardingStepLabel,
    skipButtonEl: onboardingSkipButton,
    nextButtonEl: onboardingNextButton,
    steps: ONBOARDING_STEPS,
  },
  keyboardDeps: {
    syncRelayChats,
    isLogDrawerOpen,
    closeLogDrawer,
    openLogDrawer,
  },
  eventBindings: runtimeEventBindings,
  bootstrapDeps: runtimeBootstrapDeps,
});
